# 시스템 분석

## 1. 테스트 대상 API

| Method | Endpoint | 비즈니스 목적 |
|--------|----------|--------------|
| POST | `/api/reservations` | 예약 생성 |
| GET | `/api/reservations/{id}` | 예약 상세 조회 |
| PUT | `/api/reservations/{id}` | 예약 수정 |
| DELETE | `/api/reservations/{id}` | 예약 취소 |
| GET | `/api/reservations/my` | 내 예약 목록 조회 |
| GET | `/api/sites/search` | 기간별 가용 사이트 검색 |
| GET | `/api/sites/{siteNumber}/availability` | 단일 날짜 가용성 확인 |
| GET | `/api/reservations/calendar` | 월별 예약 현황 |

---

## 2. 비즈니스 시나리오

### 시나리오 1: 예약 생성

```
1. 고객이 원하는 날짜로 가용 사이트를 검색한다
2. 검색 결과에서 사이트를 선택한다
3. 예약 정보를 입력하고 예약을 생성한다
4. 예약 성공 시 확인코드와 예약 금액을 받는다
5. 확인코드로 예약을 조회할 수 있다
```

### 시나리오 2: 예약 취소

```
1. 고객이 이름과 전화번호로 내 예약을 조회한다
2. 취소할 예약을 선택한다
3. 확인코드를 입력하여 예약을 취소한다
4. 당일 취소인 경우 환불 불가 안내를 받는다
5. 취소된 사이트는 다른 고객이 예약할 수 있다
```

### 시나리오 3: 예약 수정

```
1. 고객이 확인코드로 예약을 조회한다
2. 날짜 또는 사이트를 변경한다
3. 변경된 날짜/사이트가 가용한지 확인된다
4. 수정 성공 시 변경된 금액을 받는다
```

### 시나리오 4: 연박 예약

```
1. 고객이 시작일~종료일로 가용 사이트를 검색한다
2. 해당 기간 전체가 비어있는 사이트만 표시된다
3. 연박 예약 시 날짜별 금액이 합산된다
```

---

## 3. 비즈니스 규칙

### 예약 생성 규칙

| 규칙 | 성공 조건 | 실패 조건 |
|------|----------|----------|
| 날짜 유효성 | 시작일 >= 오늘 | 시작일 < 오늘 |
| 기간 제한 | 예약 기간 <= 30일 | 예약 기간 > 30일 |
| 날짜 순서 | 종료일 >= 시작일 | 종료일 < 시작일 |
| 중복 예약 | 해당 기간 예약 없음 | 해당 기간 예약 존재 (CONFIRMED 상태) |
| 취소된 예약 | 취소된 예약은 중복 체크 제외 | - |

### 가격 계산 규칙

| 사이트 타입 | 기본가 | 주말 할증 | 성수기 할증 | 성수기+주말 |
|------------|--------|----------|------------|------------|
| A타입 (대형) | 80,000원 | +30% | +50% | +70% |
| B타입 (소형) | 50,000원 | +30% | +50% | +70% |
| 기타 | 60,000원 | +30% | +50% | +70% |

- 연박 시 각 날짜별로 계산 후 합산

### 포인트 적립 규칙

| 조건 | 적립률 |
|------|--------|
| 기본 | 5% |
| 주말 포함 | 10% |
| 성수기 | 3% |

- 조건은 상호 배타적 (주말 포함 시 성수기여도 10% 적용)

| 결제수단 | 적립률 (기본 적립률 대체) |
|----------|--------------------------|
| 카드 | 10% |
| 모바일 | 8% |
| 계좌이체 | 5% |
| 현금 | 3% |

- 결제수단별 적립률은 기본 적립률에 추가가 아닌 **대체** 적용

### 예약 취소 규칙

| 취소 시점 | 상태 | 환불 |
|----------|------|------|
| 시작일 전 | CANCELLED | 가능 |
| 시작일 당일 | CANCELLED_SAME_DAY | 불가 |

### 예약 수정/취소 공통

- 확인코드 검증 필수 (6자리 영숫자)

---

## 4. 경계 조건

### 예약 기간

| 케이스 | 입력 | 기대 결과 |
|--------|------|----------|
| 최소 기간 | 1박 (시작일 = 종료일 - 1) | 성공 |
| 최대 기간 | 30일 | 성공 |
| 최대 기간 초과 | 31일 | 실패 |
| 오늘 시작 | 시작일 = 오늘 | 성공 |
| 과거 시작 | 시작일 = 어제 | 실패 |
| 날짜 역전 | 종료일 < 시작일 | 실패 |

### 연박 예약 가용성

| 케이스 | 상황 | 기대 결과 |
|--------|------|----------|
| 전체 가용 | 1/20~22 모두 빈 사이트 | 검색 결과에 포함 |
| 시작일 충돌 | 1/20에 예약 있음 | 검색 결과에서 제외 |
| 중간일 충돌 | 1/21에 예약 있음 | 검색 결과에서 제외 |
| 종료일 충돌 | 1/22에 예약 있음 | 검색 결과에서 제외 |

### 중복 예약

| 케이스 | 상황 | 기대 결과 |
|--------|------|----------|
| 동일 사이트, 동일 날짜 | 기존 예약 있음 (CONFIRMED) | 실패 |
| 동일 사이트, 취소된 예약 | 기존 예약 있음 (CANCELLED) | 성공 |
| 다른 사이트, 동일 날짜 | - | 성공 |

### 예약 취소 시점

| 케이스 | 상황 | 기대 결과 |
|--------|------|----------|
| 사전 취소 | 시작일 > 오늘 | CANCELLED, 환불 가능 |
| 당일 취소 | 시작일 = 오늘 | CANCELLED_SAME_DAY, 환불 불가 |
| 이미 지난 예약 | 시작일 < 오늘 | 취소 불가 (또는 별도 정책) |

### 동시성

| 케이스 | 상황 | 기대 결과 |
|--------|------|----------|
| 동시 예약 요청 | 2명이 같은 사이트, 같은 날짜 동시 예약 | 1명만 성공 |

---

## 5. 기대 동작 vs 실제 동작

### 🔴 불일치 발견 (테스트 필수)

| 기능 | 기대 동작 | 실제 동작 | 테스트 우선순위 |
|------|----------|----------|----------------|
| 연박 검색 | 시작일~종료일 **모든 날짜** 가용성 확인 | 시작일/종료일만 확인, **중간 날짜 미확인** | 높음 |
| 취소 후 재예약 | 취소된 예약은 중복 체크 **제외** | 취소된 예약도 중복으로 **판정** | 높음 |
| 동시 예약 | 같은 사이트 동시 요청 시 **1건만 성공** | **2건 모두 성공** 가능 | 높음 |
| 예약 수정 | 변경된 날짜/사이트 **중복 체크** | 중복 체크 **없음** | 높음 |

### 🟢 정상 동작 (기본 검증)

| 기능 | 기대 동작 | 실제 동작 |
|------|----------|----------|
| 예약 생성 | 확인코드 발급, 금액 계산 | 정상 |
| 예약 조회 | ID로 예약 상세 조회 | 정상 |
| 내 예약 조회 | 이름+전화번호로 목록 조회 | 정상 |
| 단일 날짜 가용성 | 특정 날짜 예약 가능 여부 | 정상 |

---

## 6. 인수 테스트 체크리스트

> 시나리오 상세는 `docs/*.feature` 파일 참조

### 예약 생성 (Top 1)

- [x] 유효한 정보로 예약 생성 (확인코드 발급)
- [x] 과거 날짜로 예약하면 실패
- [x] 종료일이 시작일보다 이전이면 실패
- [x] 동일 사이트에 겹치는 기간으로 예약하면 실패
- [x] 취소된 예약이 있는 기간에 새 예약 가능 ⚠️ 테스트 실패 (버그)
- [x] 30일 초과 예약하면 실패
- [ ] 예약 금액 반환 (API 응답에 totalPrice 필드 없음 - 테스트 불가)

### 기간별 사이트 검색 (Top 2)

- [x] 전체 기간 예약 가능한 사이트 조회
- [x] 중간 날짜에 예약이 있는 사이트는 제외 ⚠️ 테스트 실패 (버그)
- [x] 대형 사이트만 필터링
- [x] 과거 날짜로 검색하면 실패
- [x] 취소된 예약이 있는 사이트는 가용으로 표시 ⚠️ 테스트 실패 (버그)

### 예약 취소 (Top 3)

- [x] 올바른 확인코드로 사전 취소
- [x] 당일 취소 시 환불 불가 처리
- [x] 잘못된 확인코드로 취소하면 실패

---

## 7. 발견된 버그

| 버그 | 원인 | 영향 |
|------|------|------|
| 취소된 예약 있는 기간에 재예약 불가 | Repository 쿼리가 status 필터링 안 함 | 예약 생성 실패 |
| 중간 날짜 예약 체크 누락 | 시작일/종료일만 체크, 중간 날짜 미확인 | 잘못된 사이트 검색 결과 |
| 취소된 예약이 가용으로 표시 안 됨 | Repository 쿼리가 status 필터링 안 함 | 사이트 검색 결과 누락 |

> 버그 수정은 미션 3에서 진행
